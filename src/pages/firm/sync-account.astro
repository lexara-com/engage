---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Sync Account - Lexara" description="Sync your Auth0 account with the database">
  <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          Sync Your Account
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600">
          If you registered but your account wasn't properly created, use this form to sync your Auth0 account with our database.
        </p>
      </div>
      
      <form class="mt-8 space-y-6" id="sync-form">
        <div class="rounded-md shadow-sm -space-y-px">
          <div class="mb-4">
            <label for="email" class="block text-sm font-medium text-gray-700">
              Email address
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
              placeholder="your.email@example.com"
              value="shawnswaner+firm1@gmail.com"
            />
          </div>
          
          <div class="mb-4">
            <label for="auth0UserId" class="block text-sm font-medium text-gray-700">
              Auth0 User ID
            </label>
            <input
              id="auth0UserId"
              name="auth0UserId"
              type="text"
              required
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
              placeholder="auth0|..."
              value="auth0|6872aa2d816b5c05a022c40f"
            />
          </div>
          
          <div class="mb-4">
            <label for="firmName" class="block text-sm font-medium text-gray-700">
              Firm Name
            </label>
            <input
              id="firmName"
              name="firmName"
              type="text"
              required
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
              placeholder="Your Law Firm"
              value="Firm 1"
            />
          </div>
          
          <div class="mb-4">
            <label for="firstName" class="block text-sm font-medium text-gray-700">
              First Name
            </label>
            <input
              id="firstName"
              name="firstName"
              type="text"
              required
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
              placeholder="First"
              value="Shawn"
            />
          </div>
          
          <div class="mb-4">
            <label for="lastName" class="block text-sm font-medium text-gray-700">
              Last Name
            </label>
            <input
              id="lastName"
              name="lastName"
              type="text"
              required
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
              placeholder="Last"
              value="Swaner"
            />
          </div>
        </div>

        <div id="message" class="hidden rounded-md p-4"></div>

        <div>
          <button
            type="submit"
            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Sync Account
          </button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<script>
  document.getElementById('sync-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const messageDiv = document.getElementById('message');
    
    try {
      const response = await fetch('/api/v1/auth/sync-user', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });
      
      const result = await response.json();
      
      if (result.success) {
        messageDiv!.className = 'rounded-md p-4 bg-green-50 border border-green-200';
        messageDiv!.innerHTML = `
          <p class="text-sm text-green-800">
            ${result.message}<br>
            Firm ID: ${result.firm?.id}<br>
            User ID: ${result.user?.id}<br>
            <br>
            <a href="/firm/logout" class="underline font-medium">Log out</a> and then 
            <a href="/firm/login" class="underline font-medium">log back in</a> to use your synced account.
          </p>
        `;
      } else {
        messageDiv!.className = 'rounded-md p-4 bg-red-50 border border-red-200';
        messageDiv!.innerHTML = `<p class="text-sm text-red-800">Error: ${result.error}</p>`;
      }
      
      messageDiv!.classList.remove('hidden');
    } catch (error) {
      messageDiv!.className = 'rounded-md p-4 bg-red-50 border border-red-200';
      messageDiv!.innerHTML = `<p class="text-sm text-red-800">Error: ${error}</p>`;
      messageDiv!.classList.remove('hidden');
    }
  });
</script>