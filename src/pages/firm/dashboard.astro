---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import WelcomeSection from '../../components/dashboard/WelcomeSection.astro';
import MetricsCards from '../../components/dashboard/MetricsCards.astro';
import RecentConversations from '../../components/dashboard/RecentConversations.astro';
import CustomizeIntake from '../../components/dashboard/CustomizeIntake.astro';
import QuickActions from '../../components/dashboard/QuickActions.astro';
import SystemStatus from '../../components/dashboard/SystemStatus.astro';

// Server-side authentication is handled by middleware
// User info is available via Astro.locals if authenticated
const user = Astro.locals.user;
const isAuthenticated = Astro.locals.isAuthenticated;
const sessionExpiry = Astro.locals.sessionExpiry;

const { title = `Dashboard - Lexara Firm Portal`, description = "Your firm's AI-powered client intake dashboard" } = Astro.props;

// Set cache headers to prevent aggressive caching
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate, private, max-age=0');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');
Astro.response.headers.set('X-Cache-Status', 'BYPASS');
Astro.response.headers.set('X-Dashboard-Version', 'v2-new-components');
---

<DashboardLayout title={title} description={description}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Welcome Section -->
    <WelcomeSection userName={user?.name} />
    
    <!-- Metrics Cards -->
    <MetricsCards />
    
    <!-- Main Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
      <!-- Left Column - Recent Conversations (spans 2 columns on large screens) -->
      <div class="lg:col-span-2 space-y-6">
        <RecentConversations />
      </div>
      
      <!-- Right Column - Stacked Components -->
      <div class="space-y-6">
        <CustomizeIntake />
        <QuickActions />
        <SystemStatus />
      </div>
    </div>
  </div>
</DashboardLayout>